unsigned char sbox[] = {
    169, 136, 29, 53, 80, 252, 43, 63, 76, 98, 91, 72, 146, 101, 25, 128, 20, 192, 74, 213, 17, 155, 1, 158, 204, 219, 183, 190, 231, 185, 126, 181, 189, 167, 56, 159, 236, 64, 227, 137, 247, 47, 203, 19, 107, 45, 2, 226, 42, 139, 37, 51, 71, 110, 130, 174, 233, 193, 94, 118, 176, 201, 49, 160, 6, 46, 237, 127, 197, 41, 152, 92, 149, 217, 222, 168, 211, 230, 180, 209, 100, 151, 120, 132, 184, 246, 218, 157, 13, 248, 18, 112, 27, 75, 166, 198, 69, 178, 147, 89, 196, 88, 21, 145, 40, 129, 36, 208, 31, 33, 195, 216, 199, 144, 143, 58, 9, 131, 73, 78, 95, 4, 82, 15, 165, 141, 210, 212, 242, 116, 140, 124, 175, 109, 142, 121, 93, 200, 59, 48, 240, 234, 62, 117, 11, 5, 16, 22, 244, 123, 214, 239, 173, 224, 38, 205, 102, 44, 14, 202, 68, 106, 61, 65, 232, 104, 125, 255, 254, 229, 135, 8, 12, 164, 179, 7, 60, 87, 187, 245, 188, 235, 156, 79, 86, 28, 70, 50, 225, 161, 119, 172, 170, 238, 111, 191, 113, 186, 220, 162, 103, 215, 177, 182, 96, 52, 26, 163, 171, 54, 34, 250, 150, 97, 243, 84, 154, 67, 0, 23, 114, 138, 133, 194, 134, 105, 66, 83, 251, 207, 10, 99, 24, 3, 223, 32, 90, 77, 81, 253, 115, 241, 206, 249, 35, 39, 85, 122, 57, 108, 55, 153, 228, 221, 148, 30};

void midcrypt(unsigned char key[6], unsigned char in[16], unsigned char out[16]) {
    for (int i = 0; i < 16; ++i) {
        out[i] = in[i];
    }
    for (int k = 0; k < 6; ++k) {
        unsigned char x = key[k];
        for (int r = 0; r < 100; ++r) {
            for (int i = 0; i < 16; ++i) {
                x = x * 5 + 1;
                out[i] ^= x;
                out[i] = sbox[out[i]];
            }
            int first = out[0];
            for (int i = 0; i < 15; ++i) {
                out[i] = (out[i] << 3) ^ (out[i+1] >> 5);
            }
            out[15] = (out[15] << 3) ^ (first >> 5);
        }
    }
}

